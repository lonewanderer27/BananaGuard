services:
  backend:
    build: ./backend
    container_name: "banana_api"
    ports:
      - "8000:8000"
    volumes:
      - ./model:/app/model
      - ./backend:/app

  frontend:
    build: ./frontend
    container_name: "banana_web"
    ports:
      - "5173:5173"
    depends_on:
      - backend

  rag:
    build: ./rag
    container_name: banana_rag
    ports:
      - "8001:8001"
    environment:
      # Detect at runtime whether Ollama is in Docker or host
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - CHROMA_URL=${CHROMA_URL:-http://chromadb:8002}
    depends_on:
      - ollama
      - chromadb

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    ports:
      - "8002:8002"
    volumes:
      - chroma_data:/chroma

volumes:
  ollama_data:
  chroma_data:

networks:
  default:
    name: banana_net
